# 练习 2.76

## 添加新类型  / 新操作

- **带有显式分派的通用型操作**
	- 回顾
		- 这种策略需要修改通用接口函数，以检查新的类型或操作，并应用适合该情况的过程。这意味着通用接口函数必须知道所有不同的表示和操作，而且过程的名称不能相互冲突。这种策略不是可加的，因为它需要在添加新的类型或操作时更改现有的代码。
	- 添加新类型
		- 要添加新类型，必须创建构造函数 / 选择函数，并更新处理分派的 `cond` / `if` 块
			- 例如，为了添加复数的极座标表示
				- 需要创建 `make-from-real-imag-polar` 等新的构造函数
				- 需要创建 `real-part-polar` 等新的选择函数
				- 需要更新所有通用接口函数（例如 `real-part` 等）中的 `cond` 子句
				- 整个系统中，过程名称不允许重复
	- 添加新操作
		- 除了创建新的通用接口函数外，不需要更改任何代码
		- 可能需要翻来翻去地检查，以确保在 `cond` / `if` 分派表中包含每种数据类型
- **数据导向**
	- 回顾
		- 这种策略需要为每个新的类型或操作添加一个新的条目到操作-类型表中。该表由操作和类型索引，并包含实现每种类型的每种操作的过程。通用接口函数使用该表来查找给定参数的适当过程。这种策略是可加的，因为它不需要更改现有的代码，而只需要向表中添加新的条目。
	- 添加新类型
		- 创建并运行 `installer` 过程（或称包）
		- `installer` 应该
			- 实现构造函数、选择函数和每个操作
			- 使用 `put` 过程将函数安装到分派表中
		- 这种风格只需要编辑 / 调用 `installer` ，只需编辑一个代码位置即可完成（无需翻看其他地方的代码）。尽管可能需要跳转到通用函数部分以记住要实现的所有操作。
	- 添加新操作
		- 每种操作分派都写在一个单独的 `installer` 函数中。添加新操作涉及创建一个新行（通用接口）的每一列（在 `installer` 中为特定数据类型定义的操作）。必须创建新的通用接口，并编辑需要新操作的每个数据类型的 `installer` 。比较麻烦。
		- 不一定需要修改现有 `installer` 声明来添加新操作。它可以在新编写 `installer` 的块中完成，也可以通过一系列 `put` 调用注册新操作来完成：无论是对于新类型，还是在我们想要为所有类型添加操作的情况下。
- **消息传递**
	- 回顾
		- 这种策略需要定义一个新的数据对象，它响应代表操作的消息。数据对象包含表示和实现该表示的操作的过程。通用接口函数向数据对象发送消息，数据对象调用适当的过程。这种策略也是可加的，因为它不需要更改现有的代码，而只需要定义新的数据对象。
	- 添加新类型
		- 消息传递样式将数据和操作完全内化。创建新数据类型只需要创建构造函数。生成的对象必须在内部实现所有选择函数和操作。可以只编辑一个代码位置（无需跳转）添加新类型。
	- 添加新操作
		- 由于每个操作实现都是对象内部的，因此添加新操作需要编辑每个数据类型构造函数。

## 适合的系统

- 频繁添加类型
	- **消息传递的风格**，它允许每种类型封装自己的表示和操作，而不需要修改通用接口函数或操作和类型表。
	- **数据导向的风格**，可以很方便地通过 `installer` 增加新类型。
- 频繁添加操作
	- **数据导向的风格**，可以很方便地通过向表中添加新的一行，来为现有的类型添加新的操作。